generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ApplicationStage {
  SAVED
  APPLIED
  INTERVIEW
  OFFER
  REJECTED
}

enum TaskStatus {
  OPEN
  DONE
}

enum Plan {
  FREE
  PRO
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RemoteType {
  REMOTE
  HYBRID
  ONSITE
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  FREELANCE
  INTERNSHIP
}

enum InterviewType {
  PHONE
  VIDEO
  ONSITE
  TECHNICAL
  BEHAVIORAL
  FINAL
  OTHER
}

enum InterviewResult {
  PENDING
  PASSED
  FAILED
  CANCELLED
}

model User {
  id           String           @id @default(cuid())
  email        String           @unique
  passwordHash String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  deletedAt    DateTime?
  plan                 Plan     @default(FREE)
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  planUpdatedAt        DateTime?


  applications    JobApplication[]
  notes           Note[]
  tasks           Task[]
  contacts        Contact[]
  attachmentLinks AttachmentLink[]
  interviews      Interview[]
  passwordResetTokens PasswordResetToken[]
  auditLogs       AuditLog[]

  @@index([createdAt])
}

model JobApplication {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Restrict)

  company     String
  title       String
  location    String?
  url         String?
  salaryMin   Int?
  salaryMax   Int?
  salaryCurrency String?       @default("USD")
  stage       ApplicationStage  @default(SAVED)
  appliedDate DateTime?
  source      String?
  tags        String[]          @default([])
  
  // Extended fields
  priority       Priority?      @default(MEDIUM)
  remoteType     RemoteType?
  jobType        JobType?
  description    String?        // Job description for reference
  nextFollowUp   DateTime?      // When to follow up next
  rejectionReason String?       // For learning patterns

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?

  notes           Note[]
  tasks           Task[]
  contacts        Contact[]
  attachmentLinks AttachmentLink[]
  interviews      Interview[]

  @@index([userId, stage])
  @@index([userId, company])
  @@index([userId, createdAt])
  @@index([userId, updatedAt])
  @@index([userId, appliedDate])
  @@index([userId, deletedAt])
  @@index([tags], type: Gin)
}

model Note {
  id             String         @id @default(cuid())
  userId         String
  applicationId  String

  user           User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  application    JobApplication @relation(fields: [applicationId], references: [id], onDelete: Restrict)

  content        String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  @@index([userId, applicationId])
  @@index([userId, createdAt])
}

model Task {
  id             String         @id @default(cuid())
  userId         String
  applicationId  String

  user           User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  application    JobApplication @relation(fields: [applicationId], references: [id], onDelete: Restrict)

  title          String
  dueDate        DateTime?
  status         TaskStatus     @default(OPEN)

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  @@index([userId, applicationId])
  @@index([userId, status])
  @@index([userId, dueDate])
  @@index([userId, status, dueDate])
  @@index([applicationId, deletedAt])
}

model Contact {
  id            String         @id @default(cuid())
  userId        String
  applicationId String

  user          User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Restrict)

  name          String
  email         String?
  phone         String?
  role          String?        // recruiter, interviewer, hiring manager, etc.
  company       String?        // optional override

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?

  @@index([userId, applicationId])
  @@index([userId, createdAt])
}

model AttachmentLink {
  id            String         @id @default(cuid())
  userId        String
  applicationId String

  user          User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Restrict)

  label         String?
  url           String

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deletedAt     DateTime?

  @@index([userId, applicationId])
  @@index([userId, createdAt])
}

model Interview {
  id             String          @id @default(cuid())
  userId         String
  applicationId  String

  user           User            @relation(fields: [userId], references: [id], onDelete: Restrict)
  application    JobApplication  @relation(fields: [applicationId], references: [id], onDelete: Restrict)

  scheduledAt    DateTime        // Interview date/time
  duration       Int?            // Duration in minutes
  type           InterviewType   @default(VIDEO)
  location       String?         // Physical address or video link
  interviewers   String[]        @default([])
  notes          String?         // Preparation notes
  feedback       String?         // Post-interview feedback
  result         InterviewResult @default(PENDING)

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?

  @@index([userId, applicationId])
  @@index([userId, scheduledAt])
  @@index([applicationId, deletedAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum AuditAction {
  AUTH_LOGIN
  AUTH_LOGOUT
  AUTH_PASSWORD_RESET
  APPLICATION_CREATED
  APPLICATION_UPDATED
  APPLICATION_DELETED
  NOTE_CREATED
  NOTE_UPDATED
  NOTE_DELETED
  TASK_CREATED
  TASK_UPDATED
  TASK_DELETED
  CONTACT_CREATED
  CONTACT_UPDATED
  CONTACT_DELETED
  LINK_CREATED
  LINK_UPDATED
  LINK_DELETED
  INTERVIEW_CREATED
  INTERVIEW_UPDATED
  INTERVIEW_DELETED
  EXPORT_CSV
  BILLING_UPGRADED
  BILLING_DOWNGRADED
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String
  action    AuditAction
  entity    String?
  entityId  String?
  meta      Json?
  ip        String?
  userAgent String?
  createdAt DateTime    @default(now())

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([entityId])
}
